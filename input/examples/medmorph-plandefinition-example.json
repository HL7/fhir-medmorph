{
   "resourceType":"PlanDefinition",
   "id":"medmorph-plandefinition-example",
   "meta":{
      "profile":[
      	"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-plandefinition",
         "http://hl7.org/fhir/us/medmorph/StructureDefinition/medmorph-plandefinition"
      ]
   },
   "text":{
      "status":"extensions",
      "div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><p><b>MedMorph PlanDefinition Example</b></p></div>"
   },
   "extension":[
       {
           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-receiver-jwks-url",
            "valueUrl" : "http://example.org/jwks/123"
       },
       {
           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-data-encryption-algorithm",
            "valueCode" : "RSA384"
       }
   ],
   "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/medmorph-plandefinition-example",
   "version":"2.0.0",
   "name":"MedMorphPlanDefinitionExample",
   "title":"MedMorph PlanDefinition Example",
   "type":{
      "coding":[
         {
            "system":"http://terminology.hl7.org/CodeSystem/plan-definition-type",
            "code":"workflow-definition",
            "display":"Workflow Definition"
         }
      ]
   },
   "status":"active",
   "experimental":true,
   "date":"2020-07-31T12:32:29.858-05:00",
   "publisher":"eCR",
   "contact":[
      {
         "name":"HL7 International - Public Health",
         "telecom":[
            {
               "system":"url",
               "value":"http://www.hl7.org/Special/committees/pher"
            }
         ]
      }
   ],
   "description":"An example MedMorph PlanDefinition",
   "jurisdiction":[
      {
         "coding":[
            {
               "system":"urn:iso:std:iso:3166",
               "code":"US",
               "display":"United States of America"
            }
         ],
         "text":"United States of America"
      }
   ],
   "effectivePeriod":{
      "start":"2020-12-01"
   },
   "relatedArtifact":[
      {
         "type":"depends-on",
         "label":"Value Set Library of Trigger Codes",
         "resource":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
      }
   ],
   "action":[
      {
         "id":"start-workflow",
         "description":"This action represents the start of the reporting workflow in response to the encounter-start event. Other named events can be used instead of encounter-start.",
         "textEquivalent":"Start the reporting workflow in response to an encounter-start event",
         "code":[
            {
               "coding":[
                  {
                     "system":"http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions",
                     "code":"initiate-reporting-workflow",
                     "display":"Initiate a reporting workflow"
                  }
               ]
            }
         ],
         "trigger":[
            {
               "id":"encounter-start",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-named-eventtype",
                     "valueCodeableConcept":{
                        "coding":[
                           {
                              "system":"http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-triggerdefinition-namedevents",
                              "code":"encounter-start",
                              "display":"Indicates the start of an encounter"
                           }
                        ]
                     }
                  }
               ],
               "type":"named-event",
               "name":"encounter-start"
            }
         ],
         "input":[
            {
               "id":"patient",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                     "valueString":"Patient/{{context.patientId}}"
                  }
               ],
               "type":"Patient"
            },
            {
               "id":"encounter",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                     "valueString":"Encounter/{{context.encounterId}}"
                  }
               ],
               "type":"Encounter"
            }
         ],
         "relatedAction":[
            {
               "actionId":"check-reportability",
               "relationship":"before-start",
               "offsetDuration":{
                  "value":60,
                  "system":"http://unitsofmeasure.org",
                  "code":"s"
               }
            }
         ]
      },
      {
         "id":"check-reportability",
         "description":"This action represents the start of the check for reportable conditions in response to the encounter-start event. This is an example of executing a reporting workflow with other actions.",
         "textEquivalent":"Check Reportability and setup jobs for future reportability checks.",
         "code":[
            {
               "coding":[
                  {
                     "system":"http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions",
                     "code":"execute-reporting-workflow"
                  }
               ]
            }
         ],
         "action":[
            {
               "id":"is-encounter-reportable",
               "description":"This action represents the check for reportability to create the Report.",
               "textEquivalent":"Check Trigger Codes based on Value sets.",
               "code":[
                  {
                     "coding":[
                        {
                           "system":"http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions",
                           "code":"check-trigger-codes"
                        }
                     ]
                  }
               ],
               "condition":[
                  {
                     "kind":"applicability",
                     "expression":{
                        "language":"text/fhirpath",
                        "expression":"%encounter.where(%encounterStartDate + 1 day * %normalReportingDuration >= now()).select(true) and (%conditions.exists() or %encounters.exists() or %immunizations.exists() or %procedures.exists() or %procedureOrders.exists() or %labOrders.exists() or %labTests.exists() or %labResults.exists() or %medicationAdministrations.exists() or %medicationOrders.exists() or %medicationDispenses.exists())"
                     }
                  }
               ],
               "input":[
                  {
                     "id":"conditions",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"Condition?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"Condition",
                     "codeFilter":[
                        {
                           "path":"code",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"encounters",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                           "valueString":"encounter"
                        }
                     ],
                     "type":"Encounter",
                     "codeFilter":[
                        {
                           "path":"reasonCode",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"immunizations",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"Immunization?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"Immunization",
                     "codeFilter":[
                        {
                           "path":"vaccineCode",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"labOrders",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"ServiceRequest?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"ServiceRequest",
                     "codeFilter":[
                        {
                           "path":"code",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"labTests",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"Observation?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"Observation",
                     "codeFilter":[
                        {
                           "path":"code",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"diagnosticOrders",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"DiagnosticReport?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"DiagnosticReport",
                     "codeFilter":[
                        {
                           "path":"code",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"procedureOrders",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"ServiceRequest?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"ServiceRequest",
                     "codeFilter":[
                        {
                           "path":"code",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"procedures",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"Procedure?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"Procedure",
                     "codeFilter":[
                        {
                           "path":"code",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"medicationOrders",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"MedicationRequest?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"MedicationRequest",
                     "codeFilter":[
                        {
                           "path":"medication",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"medicationDispenses",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"MedicationDispense?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"MedicationDispense",
                     "codeFilter":[
                        {
                           "path":"medication",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"medicationAdministrations",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-fhirquerypattern-extension",
                           "valueString":"MedicationAdministration?patient=Patient/{{context.patientId}}"
                        }
                     ],
                     "type":"MedicationAdministration",
                     "codeFilter":[
                        {
                           "path":"medication",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"labResults",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                           "valueString":"labTests"
                        }
                     ],
                     "type":"Observation",
                     "codeFilter":[
                        {
                           "path":"value",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  },
                  {
                     "id":"diagnosticResults",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                           "valueString":"diagnosticOrders"
                        }
                     ],
                     "type":"DiagnosticReport",
                     "codeFilter":[
                        {
                           "path":"code",
                           "valueSet":"http://hl7.org/fhir/us/medmorph/ValueSet/valueset-cancer-trigger-codes-example"
                        }
                     ]
                  }
               ],
               "relatedAction":[
                  {
                     "actionId":"create-report",
                     "relationship":"before-start"
                  }
               ]
            }
         ]
      },
      {
         "id":"create-report",
         "description":"This action represents the creation of the Report. It subsequently calls validate.",
         "textEquivalent":"Create Report",
         "code":[
            {
               "coding":[
                  {
                     "system":"http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions",
                     "code":"create-report"
                  }
               ]
            }
         ],
         "input":[
            {
               "id":"patientdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"patient"
                  }
               ],
               "type":"Patient",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"
               ]
            },
            {
               "id":"conditiondata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"conditions"
                  }
               ],
               "type":"Condition",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-condition"
               ]
            },
            {
               "id":"encounterdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"encounter"
                  }
               ],
               "type":"Encounter",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-encounter"
               ]
            },
            {
               "id":"mrdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"medicationOrders"
                  }
               ],
               "type":"MedicationRequest",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-medicationrequest"
               ]
            },
            {
               "id":"immzdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"immunizations"
                  }
               ],
               "type":"Immunization",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-immunization"
               ]
            },
            {
               "id":"procdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"procedures"
                  }
               ],
               "type":"Procedure",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-procedure"
               ]
            },
            {
               "id":"labResultdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"labResults"
                  }
               ],
               "type":"Observation",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-observation-lab"
               ]
            },
            {
               "id":"labOrderdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"labOrders"
                  }
               ],
               "type":"ServiceRequest",
               "profile":[
                  "http://hl7.org/fhir/StructureDefinition/ServiceRequest"
               ]
            },
            {
               "id":"diagnosticResultdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"diagnosticResults"
                  }
               ],
               "type":"DiagnosticReport",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-diagnosticreport-lab"
               ]
            },
            {
               "id":"diagnosticOrderdata",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"diagnosticOrders"
                  }
               ],
               "type":"DiagnosticReport",
               "profile":[
                  "http://hl7.org/fhir/us/core/StructureDefinition/us-core-diagnosticreport-lab"
               ]
            }
         ],
         "output":[
            {
               "id":"output-report",
               "type":"Bundle",
               "profile":[
                  "http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-reporting-bundle"
               ]
            }
         ],
         "relatedAction":[
            {
               "actionId":"validate-report",
               "relationship":"before-start"
            }
         ],
         "action":[
            {  
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-trust-service-endpoint",
                     "valueReference" : {
		              	"reference" : "Endpoint/example-ph-endpoint"
		            }
                  }
               ],
               "id":"anonymize-report",
               "description":"This action is used to anonymize a identifiable report",
               "textEquivalent":"Anonymize the report.",
               "code":[
                  {
                     "coding":[
                        {
                           "system":"http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions",
                           "code":"anonymize-report"
                        }
                     ]
                  }
               ],
               "input":[
                  {
                     "id":"report-to-be-anonymized",
                     "extension":[
                        {
                           "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                           "valueString":"output-report"
                        }
                     ],
                     "type":"Bundle"
                  }
                ],
                "output":[
	            	{
		               "id":"anonymized-report",
		               "type":"Bundle",
		               "profile":[
		                  "http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-reporting-bundle"
		               ]
	            	}
         		]
            }
         ]
      },
      {
         "id":"validate-report",
         "description":"This action represents the validation of the Report. It subsequently calls route-and-send.",
         "textEquivalent":"Validate Report",
         "code":[
            {
               "coding":[
                  {
                     "system":"http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions",
                     "code":"validate-report"
                  }
               ]
            }
         ],
         "input":[
            {
               "id":"generated-report",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"output-report"
                  }
               ],
               "type":"Bundle",
               "profile":[
                  "http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-reporting-bundle"
               ]
            }
         ],
         "output":[
            {
               "id":"valid-report",
               "type":"Bundle",
               "profile":[
                  "http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-reporting-bundle"
               ]
            }
         ],
         "relatedAction":[
            {
               "actionId":"route-and-send-report",
               "relationship":"before-start"
            }
         ]
      },
      {
         "id":"route-and-send-report",
         "description":"This action represents the routing and sending of the Report.",
         "textEquivalent":"Route and send Report",
         "code":[
            {
               "coding":[
                  {
                     "system":"http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions",
                     "code":"submit-report"
                  }
               ]
            }
         ],
         "input":[
            {
               "id":"validated-report",
               "extension":[
                  {
                     "url":"http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-relateddata-extension",
                     "valueString":"valid-report"
                  }
               ],
               "type":"Bundle",
               "profile":[
                  "http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-reporting-bundle"
               ]
            }
         ],
         "output":[
            {
               "id":"submitted-report",
               "type":"Bundle",
               "profile":[
                  "http://hl7.org/fhir/us/medmorph/StructureDefinition/us-ph-reporting-bundle"
               ]
            }
         ]
      }
   ]
}